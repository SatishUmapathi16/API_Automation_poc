name: Run Newman Suites (API_Automation_poc)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:

jobs:
  run-newman:
    runs-on: windows-latest

    env:
      PROJECT_ROOT: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo layout (debug)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          Get-ChildItem $env:GITHUB_WORKSPACE | Format-Table -AutoSize

          # Validate required files exist in repo root
          foreach ($f in @("run-all.ps1","my-script.txt","scripts","EY.COM","Reports","EmailReports")) {
            $p = Join-Path $env:GITHUB_WORKSPACE $f
            if (-not (Test-Path $p)) { throw "Missing required path: $p" }
          }

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Newman + reporters
        shell: pwsh
        run: |
          npm i -g newman newman-reporter-htmlextra
          node -v
          newman -v
          where.exe newman

      - name: Run AccelQ runner (PowerShell)
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          powershell.exe -NoProfile -ExecutionPolicy Bypass -File ".\run-all.ps1"

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-automation-reports
          path: |
            EmailReports
            Reports
            EY.COM\**\Reports
            run_timing_*.txt
          if-no-files-found: warn
